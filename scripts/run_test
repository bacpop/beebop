set -e

CONTAINER_NAME=beebop_py
PORT=5000
docker pull mrcide/beebop-py
docker run --rm -d --name=$CONTAINER_NAME -p $PORT:8080 mrcide/beebop-py
npm --prefix app/server install
npm --prefix app/client install
npm install pm2

# From now on, if the user presses Ctrl+C we should teardown
function cleanup() {
    docker stop $CONTAINER_NAME
    pm2 delete beebop_client
    pm2 delete beebop_server

}
trap cleanup INT
trap cleanup ERR

node ./node_modules/pm2/bin/pm2 --name beebop_server start "BEEBOP_TEST="true" npm run --prefix app/server express"
node ./node_modules/pm2/bin/pm2 --name beebop_client start "npm run --prefix app/client serve"
